{{template "layout.tmpl" .}}
<h1>{{if .Item}}Правка блюда{{else}}Новое блюдо{{end}}</h1>

<form method="post" action="{{if .Item}}/admin/foods/save{{else}}/admin/foods/create{{end}}">
  {{if .Item}}<input type="hidden" name="id" value="{{.Item.ID}}">{{end}}

  <label>Название
    <input name="name" value="{{with .Item}}{{.Name}}{{end}}" required>
  </label><br>

  <label>Категория
    <select name="category_id" required>
      {{range .Cats}}
        <option value="{{.ID}}" {{with $.Item}}{{if eq .CategoryID $.ID}}selected{{end}}{{end}}>{{.Name}}</option>
      {{end}}
    </select>
  </label><br>

  <label class="checkbox">
    <input type="checkbox" id="is_complex" name="is_complex" {{with .Item}}{{if .IsComplex}}checked{{end}}{{end}}>
    Сложное блюдо
  </label>

  <!-- Секция ингредиентов: показывается только если стоит чекбокс -->
  <div id="complex_section" style="margin-top:12px; display:none;">
    <h3>Ингредиенты блюда</h3>
    <table id="ing_table">
      <tr><th>Ингредиент</th><th>Кол-во</th><th>Ед.</th><th></th></tr>

      {{range .Rows}}
      <tr>
        <td>
          {{$row := .}}
          <select name="ingredient_id[]">
            {{range $.Ings}}
              <option value="{{.ID}}" {{if eq .ID $row.IngredientID}}selected{{end}}>{{.Name}}</option>
            {{end}}
          </select>
        </td>
        <td><input type="number" step="0.01" name="quantity[]" value="{{$row.Quantity}}" required></td>
        <td><input type="text" name="unit[]" value="{{$row.Unit}}" required></td>
        <td><button type="button" onclick="delRow(this)">✕</button></td>
      </tr>
      {{end}}


    </table>

    <button type="button" onclick="addRow()">+ Добавить ингредиент</button>
  </div>

  <br>
  <button type="submit">Сохранить</button>
</form>

<script>
(function(){
  const box = document.getElementById('is_complex');
  const sec = document.getElementById('complex_section');
  function toggle(){ sec.style.display = box.checked ? 'block' : 'none'; }
  box.addEventListener('change', toggle);
  toggle();

  window.addRow = function(){
    const table = document.getElementById('ing_table');
    const tr = document.createElement('tr');

    // ячейка select ингредиента
    const td1 = document.createElement('td');
    td1.innerHTML = `\
<select name="ingredient_id[]">
  {{range .Ings}}<option value="{{.ID}}">{{.Name}}</option>{{end}}
</select>`;
    // количество
    const td2 = document.createElement('td');
    td2.innerHTML = '<input type="number" step="0.01" name="quantity[]" required>';
    // ед.
    const td3 = document.createElement('td');
    td3.innerHTML = '<input type="text" name="unit[]" placeholder="г/мл/шт" required>';
    // удалить
    const td4 = document.createElement('td');
    td4.innerHTML = '<button type="button" onclick="delRow(this)">✕</button>';

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
    table.appendChild(tr);
  }

  window.delRow = function(btn){
    const tr = btn.closest('tr');
    tr.parentNode.removeChild(tr);
  }
})();
</script>
